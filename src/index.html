<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <meta charset="utf-8">
  <title>AltJS</title>
  <link rel="stylesheet" type="text/css" href="./style.css" />
  <link type="text/javascript" href="lang/biwascheme.js" />
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
  <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
  <div class="App">
    <script>
      var app = {}
      app.translations = {
        en: {
          biwascheme: "BiwaScheme",
          clojurescript: "ClojureScript",
          haste: "Haste",
          js_of_ocaml: "Js_of_ocaml",
          jsprolog: "jsprolog",
          scalajs: "Scala.js",

          biwascheme_intro: "BiwaScheme is a Scheme interpreter written in JavaScript.",
          clojurescript_intro: "ClojureScript is a compiler for Clojure that targets JavaScript.",
          haste_intro: "Haste is a compiler generating JavaScript code from Haskell.",
          js_of_ocaml_intro: "Js_of_ocaml is a compiler of OCaml bytecode to Javascript. It makes it possible to run Ocaml programs in a Web browser.",
          jsprolog_intro: "jsprolog is a Prolog parser, compiler and interpreter written in Javascript.",
          scalajs_intro: "Scala.js is a Scala to JavaScript compiler.",

          instruction: "Please type in some code!",
          query: "Please enter a query!",
          checkbox: "Show parsing results",
          resultStr: "Result"
        },
        fr: {
          biwascheme_intro: "Biwascheme est un interpréteur du langage Scheme, écrit en JavaScript.",
          haste_intro: "Haste est un compilateur générant du code JavaScript depuis Haskell.",
          jsprolog_intro: "jsprolog est un parseur, compilateur et interpréteur du langage Prolog, écrit en Javascript.",

          instruction: "Merci d'entrer du code!",
          query: "Merci d'entrer une requête!",
          checkbox: "Afficher les résultats de l'analyse syntaxique",
          resultStr: "Résultat"
        },
        ja: {
          biwascheme_intro: "BiwaScheme は JavaScript で 書かれた Scheme インタプリタです。",
          haste_intro: "Haste は、Haskell から JavaScript コードを生成するコンパイラです。",
          jsprolog_intro: "jsprolog は Javascript で 書かれた Prolog パーサ、コンパイラ、インタプリタです。",

          instruction: "コードを入力してください！",
          query: "クエリを入力してください！",
          checkbox: "構文解析の結果を表示する",
          resultStr: "結果"
        },
        pt: {
          biwascheme_intro: "BiwaScheme é um interpretador Scheme escrito em JavaScript.",
          haste_intro: "Haste é um compilador que gera código JavaScript da Haskell.",
          jsprolog_intro: "jsprolog é um analisador Prolog, compilador e intérprete escrito em Javascript.",

          instruction: "Por favor, introduza código!",
          query: "Por favor, indique uma consulta!",
          checkbox: "Mostrar os resultados da análise sintática",
          resultStr: "Resultado"
        }
      };

      app.logo = {
        biwascheme: "biwascheme.png",
        clojurescript: "clojurescript.png",
        haste: "haskell.svg", // TODO: change the logo to the js one
        js_of_ocaml: "js_of_ocaml.svg",
        jsprolog: "prolog.png", //  TODO: change the logo to the js one
        scalajs: "scalajs.svg"
      }

      app.sample = {
        biwascheme: {
          hello_world: {
            0: 'Hello World',
            1: '(print "Hello world!")'
          },
          fibonacci: {
            0: 'Fibonacci',
            1: "(define (fib n)\n(if (< n 2) n (+ (fib (- n 1))\n(fib (- n 2)))))\n(fib 9)"
          }
        },
        haste: {
          canvas: {
            0: 'canvas simple',
            1: 'import Haste\nimport Haste.Graphics.Canvas\nsquareShape :: Shape ()\nsquareShape = do\n  rect (-20, -20) (20, 20)\n  rect (-10, -10) (10, 10)\n  line (-20, -20) (20, 20)\nsquare :: Picture ()\nsquare = stroke squareShape\nfilledSquare :: Picture ()\nfilledSquare = fill squareShape\nmain :: IO ()\nmain = do\n  Just can <- getCanvasById "canvas"\n  animate can 0\nanimate :: Canvas -> Double -> IO ()\nanimate can angle = do\n  render can $ do\n    translate (160, 160) $ rotate angle $ do\n      square\n      translate (100, 100) . rotate (-angle) . color (RGB 255 0 0) $ filledSquare\n    color (RGBA 0 0 255 0.5) . font "20px Bitstream Vera" $ do\n      text (10, 160) "You can use transparency too!"\n  setTimer (Once 10) $ animate can (angle + 0.01)\n  return ()'
          }
        },
        jsprolog: {
          elements: {
            0: 'elements',
            1: '# Enter your ruleset in here.\ntriple(sc, a, b).\ntriple(sc, b, c).\ntriple(sc, c, d).\ntriple(sc, d, e).\ntriple(sc, e, f).\ntriple(sc, f, g).\ntriple(type, sc, transitive).\ntriple(P, X, Y) :- NOTTHIS triple(type, P, transitive), NOTTHIS triple(P, X, Z), triple(P, Z, Y).\narcsOut(X, L) :- bagof(O, triple(P, X, O), L).\n### Accumulated standard library lives under here!\n# unification and ( x, y, z; w ) support\nunify(X, X).\n# ( a, b, c ) --> conjunction([a, b, c])\nconjunction([]).\nconjunction([X | Rest]) :- call(X), conjunction(Rest).\n# ( a; b; c ) --> disjunction([a, b, c])\ndisjunction([X | Rest]) :- call(X).\ndisjunction([X | Rest]) :- disjunction(Rest).\n# Arithmetic\nadd(A, B, C) :- external("$1 + $2", [A, B], C).   # A + B = C, etc.\nsub(A, B, C) :- external("$1 - $2", [A, B], C).\nmul(A, B, C) :- external("$1 * $2", [A, B], C).\ndiv(A, B, C) :- external("$1 / $2", [A, B], C).\n# The canonical quicksort\nqsort([], []).\nqsort([X|Rest], Answer) :- partition(X, Rest, [], Before, [], After), qsort(Before, Bsort), qsort(After, Asort), append(Bsort, [X | Asort], Answer).\npartition(X, [], Before, Before, After, After).\npartition(X, [Y | Rest], B, [Y | Brest], A, Arest) :- leq(X, Y), partition(X, Rest, B, Brest, A, Arest).\npartition(X, [Y | Rest], B, Brest, A, [Y | Arest]) :- gtr(X, Y), partition(X, Rest, B, Brest, A, Arest).\nleq(X, Y) :- compare(X, Y, gt).\nleq(X, Y) :- compare(X, Y, eq).\ngtr(X, Y) :- compare(X, Y, lt).\n# Some list-processing stuff...\nappend([], Z, Z).\nappend([A|B], Z, [A|ZZ]) :- append(B, Z, ZZ).\nreverse([], []).\nreverse([A|B], Z) :- reverse(B, Brev), append(Brev, [A], Z).\nlength([], 0).\nlength([H|T], N) :- length(T, M), add(M, 1, N).\n# Standard prolog not/1\nnot(Term) :- call(Term), !, fail.\nnot(Term).\n# Standard prolog var/1\nvar(X) :- bagof(l, varTest(X), [l, l]).\nvarTest(a).\ntarTest(b).',
            2: 'bagof(c, triple(sc, A, B), L), length(L, N) # L should have 21 elements'
          }
        }
      }

      var currentLanguage = document.documentElement.lang || "en";
      var currentPgmLanguage = "biwascheme";

      function gettext(key) {
        return app.lang[key] || app.translations.en[key] || "{translation key not found: " + key + "}";
      }

      function getlogo(key) {
        return "logos/" + app.logo[key];
      }

      function getSample(sample, i) {
        return app.samples[sample][i];
      }
    </script>

    <div class="App-header">
      <img class="App-logo" id="app-logo" alt="logo" style="height:105px" />
      <h3 id="language-name"></h3>

      <select id="lang-select" onchange="changeLang(this.value)">
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="ja">日本語</option>
            <option value="pt">Português</option>
          </select>

      <select id="pgm-lang-select" onchange="changePgmLang(this.value)">
            <option value="biwascheme">BiwaScheme</option>
            <option value="clojurescript">ClojureScript</option>
            <option value="haste">Haste</option>
            <option value="js_of_ocaml">Js_of_ocaml</option>
            <option value="jsprolog">jsprolog</option>
            <option value="scalajs">Scala.js</option>
          </select>
    </div>
    <p id="intro" class="App-intro"></p>

    <script type="text/javascript" src="lang/biwascheme.js"></script>
    <script>
      function handleClick() {
        var codeEntry = document.getElementById('code-entry');
        var resultOutput = document.getElementById("result");
        var extraInputs = document.getElementById("extra-inputs");
        var code = codeEntry.value;
        var extra = document.getElementById("extra");
        clearResults();
        if (extraInputs.firstChild) {
            var extraField = document.getElementById("extra-text-entry");
            var extraFieldValue = extraField.value;
        }
        if (code == "") {
          resultOutput.value = code;
        } else {
          switch (currentPgmLanguage) {
            case "biwascheme": // biwascheme interpretation
              var consoleElement = document.createElement("div");
              consoleElement.setAttribute("id", 'bs-console');
              extra.appendChild(consoleElement);

              var biwascheme = new BiwaScheme.Interpreter(function(e, state) {
                $('output')[0].innerHTML += e.message;
              });
              var onError = function(e) {
                console.error(e);
              }
              var biwa = new BiwaScheme.Interpreter(onError)
              biwa.evaluate(code, function(result) {
                resultOutput.value = result;
              });
              break;
            case "clojurescript": // clojurescript interpretation
              // TODO: add the clojurescript interpretation
              break;
            case "haste": // haste interpretation
              var compilerUrl = "https://platy.eng.kagawa-u.ac.jp/WappenWeb/HasteCompiler";
              $(function() {
                var source = code;
                var name = "user-input.hs";
                var file = new File([source], name);
                var formData = new FormData();
                formData.append(name, file);
                $.ajax({
                  url: compilerUrl,
                  type: "POST",
                  processData: false,
                  contentType: false,
                  data: formData
                }).done(function(data) {
                  $("#result").val(data);

                  // creates the canvas to diplay the result
                  var canvas = document.createElement("canvas");
                  canvas.setAttribute("id", 'canvas');
                  canvas.setAttribute("style", "border: 1px solid black;");
                  canvas.setAttribute("width", "320");
                  canvas.setAttribute("height", "320");
                  extra.appendChild(canvas);

                  // creates the script from js code returned by haste
                  var script = document.createElement("script");
                  script.innerHTML = data;
                  extra.appendChild(script);

                  // script to call the main function of the previous script
                  var s = document.createElement('script');
                  s.type = 'text/javascript';
                  var code = 'hasteMain();';
                  try {
                    s.appendChild(document.createTextNode(code));
                    document.body.appendChild(s);
                  } catch (e) {
                    s.text = code;
                    extra.appendChild(s);
                  }

                }).fail(function(msg) {
                  console.log("failure", msg);
                });


                return false;

              });
              break;
            case "js_of_ocaml": // js_of_ocaml interpretation
              // TODO: add the js_of_ocaml interpretation
              break;
            case "jsprolog": // jsprolog interpretation
              freeform(code, extraFieldValue);
              break;
            case "scalajs": // scalajs interpretation
              // TODO: add the scalajs interpretation
              break;
            default:
              // shouldn't be reached
              console.log("You shouldn't reach this part of the code!");
          }
        }
        clearInputs();
      }
    </script>

    <button id="run-button" type="Button" onClick="handleClick()">&#9658;</button>

    <div class="App-content" id="app-content">
      <div class="Code-area">
        <textarea class="Code-entry" id="code-entry"></textarea>
        <div id="extra-inputs"></div>
      </div>

      <div class="Result-area">
        <textarea class="Result" id="result" disabled="disabled"></textarea>
      </div>

      <div class="Extra-area">
        <div id="extra" class="Extra"></div>
      </div>
    </div>

    <div id="buttons-div"></div>
    <script type="text/javascript" src="lang/jsprolog.js"></script>
    <script>
      function displayStrings() {
        app.lang = app.translations[currentLanguage] || app.translations.en;
        document.getElementById("language-name").innerHTML = gettext(currentPgmLanguage);
        document.getElementById("intro").innerHTML = gettext(currentPgmLanguage + "_intro");
        document.getElementById("code-entry").placeholder = gettext("instruction");
        if (document.getElementById("extra-inputs").firstChild) {
          document.getElementById("extra-text-entry").placeholder = gettext("query");
          var label = document.getElementById("checkbox-label");
          if(!label.firstChild){
            label.appendChild(document.createTextNode(gettext("checkbox")));
          } else {
            label.innerHTML = gettext("checkbox");
          }
        }
        document.getElementById("result").placeholder = gettext("resultStr");
      }

      function updateLogo() {
        document.getElementById("app-logo").src = getlogo(currentPgmLanguage);
      }

      function initSamples() {
        app.samples = app.sample[currentPgmLanguage];
      }

      function init() {
        clearExtraInputFields();
        displayExtraInputs();
        displayStrings();
        updateLogo();
        initSamples();
        displayButtons();
      }


      function changeLang(lang) {
        currentLanguage = lang;
        displayStrings();
      }

      function changePgmLang(lang) {
        currentPgmLanguage = lang;
        init();
        clearDisplays();
      }

      function displayExtraInputs() {
        if (currentPgmLanguage == "jsprolog") {
          var extraInputs = document.getElementById("extra-inputs");
          var extraTextArea = document.createElement("textarea");
          extraTextArea.setAttribute("id", "extra-text-entry");
          extraTextArea.setAttribute("class", "Extra-text-area");
          var checkbox = document.createElement("input");
          checkbox.setAttribute("id", "extra-checkbox");
          checkbox.setAttribute("type", "checkbox");
          var label = document.createElement("label");
          label.setAttribute("id", "checkbox-label");
          label.setAttribute("for", "extra-checkbox");
          extraInputs.appendChild(document.createElement("br"));
          extraInputs.appendChild(extraTextArea);
          extraInputs.appendChild(checkbox);
          extraInputs.appendChild(label);
        }
      }

      function displaySample(sample) {
        document.getElementById("code-entry").value = getSample(sample, 1);
        if(document.getElementById("extra-inputs").firstChild) {
          document.getElementById("extra-text-entry").value = getSample(sample, 2);
        }
      }


      function displayButtons() {
        var buttons = document.getElementById("buttons-div");

        // clears the buttons area
        while (buttons.firstChild) {
          buttons.removeChild(buttons.firstChild);
        }

        var samples = app.samples; // samples of the current language

        // creates a button for each sample
        for (var s in samples) {
          var button = document.createElement("button");
          let sampleToLoad = s;
          button.innerHTML = samples[s][0];
          button.addEventListener("click", function() {
            displaySample(sampleToLoad);
          });
          buttons.appendChild(button);
        }
      }

      function clearDisplays() {
        clearInputs();
        clearResults();
      }

      function clearInputs() {
        var codeEntry = document.getElementById('code-entry');
        var extraInputs = document.getElementById("extra-inputs");
        codeEntry.value = "";
        if (extraInputs.firstChild) {
          var extraTextEntry = document.getElementById("extra-text-entry");
          extraTextEntry.value = "";
        }

      }

      function clearResults() {
        var resultOutput = document.getElementById("result");
        resultOutput.value = "";
        var extra = document.getElementById("extra");
        while (extra.firstChild) {
          extra.removeChild(extra.firstChild);
        }
      }

      function clearExtraInputFields() {
        var extraInputs = document.getElementById("extra-inputs");
        while (extraInputs.firstChild) {
          extraInputs.removeChild(extraInputs.firstChild);
        }
      }
      // launched at the first creation of the page
      document.getElementById("pgm-lang-select").value = currentPgmLanguage;
      init();
    </script>
  </div>
</body>

</html>
